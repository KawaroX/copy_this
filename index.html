<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>快速复制 · 双页面（输入/结果）</title>
  <!-- Favicon：使用📦表情作为图标 -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">📦</text></svg>' />
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--bg:#f8f8f6;--fg:#37352f;--muted:#787774;--line:#e3e2e0;--card:#fff;--accent:#0f7b6c}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Noto Sans',sans-serif;background:var(--bg);color:var(--fg);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:16px}
    .wrap{width:100%;max-width:720px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 1px 3px rgba(0,0,0,.04),0 10px 36px rgba(0,0,0,.06);padding:20px}
    .head{display:flex;align-items:center;gap:10px;margin-bottom:12px}
    .head .icon{font-size:28px}
    h1{font-size:20px}
    .sub{color:var(--muted);font-size:13px}

    .label{font-size:12px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;margin:14px 0 8px}
    textarea,input[type=text]{width:100%;border:1px solid var(--line);border-radius:10px;padding:12px 14px;background:#fff;color:var(--fg);font:inherit}
    textarea{min-height:140px;resize:vertical}
    .row{display:flex;gap:10px;align-items:center}
    .row>*{flex:1}
    .opt{display:flex;align-items:center;gap:8px}
    .small{font-size:12px;color:var(--muted)}
    .btn{border:none;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer}
    .btn-primary{background:var(--fg);color:#fff}
    .btn-primary:active{transform:scale(.985)}
    .btn-secondary{background:#fff;color:var(--fg);border:1px solid var(--line)}

    .display{white-space:pre-wrap;word-break:break-word;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;border:1px solid var(--line);background:#fff;border-radius:10px;padding:12px}
    .parts{display:flex;flex-direction:column;gap:10px}
    .part{display:flex;gap:10px;align-items:center;border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 12px}
    .part:hover{background:#f6f6f4}
    .k{min-width:72px;font-size:11px;color:var(--muted)}
    .v{flex:1}
    .active{border-color:#90caf9;background:#e3f2fd}

    .status{margin-top:8px;padding:10px 12px;border-radius:10px;display:none}
    .status.show{display:block}
    .ok{background:#edf3ec;color:#0f7b6c}
    .err{background:#fdebec;color:#e03e3e}

    .footer{margin-top:12px;color:#9b9a97;font-size:12px}

    /* Mobile 优化：固定底部按钮条 */
    .bar{position:sticky;bottom:0;display:flex;gap:8px;background:linear-gradient(180deg,rgba(248,248,246,0),var(--bg) 40%);padding-top:10px}
    .bar .btn{flex:1}

    /* 视图隐藏控制 */
    [data-view]{display:none}
    [data-view].show{display:block}
  </style>
</head>
<body>
  <div class="wrap">

    <!-- 输入页 -->
    <section id="view-input" data-view class="card">
      <div class="head"><div class="icon">📋</div><div><h1>快速复制</h1><div class="sub">输入/粘贴短信 → 智能抽取 → 生成可分享链接；手机上更好用</div></div></div>

      <div class="label">输入文本</div>
      <textarea id="ipt-text" placeholder="粘贴快递短信或任意文本... 地址：…"></textarea>

      <div class="row" style="margin-top:10px">
        <label class="opt"><input type="checkbox" id="ipt-auto" checked> 自动分离</label>
        <div class="opt" style="flex:.9"><span class="small">自定义分隔符</span><input id="ipt-split" type="text" placeholder=", 或 | 或 \n" /></div>
      </div>

      <div class="bar" style="margin-top:12px">
        <button id="btn-go" class="btn btn-primary">解析并查看结果</button>
        <button id="btn-link" class="btn btn-secondary">生成分享链接</button>
      </div>

      <div id="status-input" class="status"></div>

      <div class="footer">
        URL 参数：<code>?code=内容</code>、<code>?text=内容&mode=auto</code>、<code>?text=内容&split=,</code>、<code>?values=1,2,3</code>
      </div>
    </section>

    <!-- 结果页 -->
    <section id="view-result" data-view class="card">
      <div class="head">
        <button id="btn-back" class="btn btn-secondary" style="padding:8px 12px">← 返回</button>
        <div><h1>解析结果</h1><div class="sub">点击任意条目即可复制；支持多选批量复制</div></div>
      </div>

      <div class="label">原文</div>
      <div id="full" class="display">-</div>

      <div class="label">抽取项</div>
      <div id="parts" class="parts"></div>

      <div class="row" style="margin-top:10px">
        <label class="opt small"><input type="checkbox" id="opt-multi"> 多选模式</label>
        <div class="opt small"><input type="checkbox" id="opt-onlycode"> 只看取件码/码类</div>
      </div>

      <div class="bar" style="margin-top:12px">
        <button id="btn-copy-all" class="btn btn-secondary">复制原文</button>
        <button id="btn-copy-selected" class="btn btn-primary" disabled>复制选中（0）</button>
      </div>

      <div id="status-result" class="status"></div>
    </section>

  </div>

  <script>
    const $ = (id)=>document.getElementById(id);

    /* ======= 路由（输入/结果 两页） ======= */
    function show(view){
      for (const el of document.querySelectorAll('[data-view]')) el.classList.remove('show');
      $(view).classList.add('show');
    }

    function navigateToResult(params){
      const url = new URL(location.href);
      url.searchParams.set('view','result');
      for (const [k,v] of Object.entries(params)) if(v!=null) url.searchParams.set(k,v);
      history.pushState({page:'result'}, '', url);
      renderFromParams();
    }

    function navigateToInput(){
      const url = new URL(location.href);
      url.searchParams.delete('view');
      url.searchParams.delete('text');
      url.searchParams.delete('code');
      url.searchParams.delete('values');
      url.searchParams.delete('mode');
      url.searchParams.delete('split');
      history.pushState({page:'input'}, '', url.pathname + url.search);
      renderFromParams();
    }

    window.addEventListener('popstate', renderFromParams);

    /* ======= 工具 ======= */
    const sanitize = (s='')=> s
      .replace(/[\u200B-\u200D\uFEFF]/g,'') // 去零宽
      .replace(/[\s\t\xA0]+/g,' ') // 合并空格
      .replace(/\s*([，。；,;:：])\s*/g,'$1');

    async function copy(text, okMsg='已复制'){
      try{ await navigator.clipboard.writeText(text); toast(okMsg,true) }
      catch{
        const ta=document.createElement('textarea'); ta.value=text; ta.style.position='fixed'; ta.style.left='-9999px'; document.body.appendChild(ta); ta.select();
        try{ document.execCommand('copy'); toast(okMsg,true) } catch{ toast('复制失败，请手动复制',false) }
        document.body.removeChild(ta);
      }
    }

    function toast(msg, ok=true, where='input'){
      const el = where==='input' ? $('status-input') : $('status-result');
      el.textContent = msg; el.className = 'status show ' + (ok?'ok':'err');
      clearTimeout(el._t); el._t = setTimeout(()=>{ el.className = 'status' }, 2600);
    }

    /* ======= 智能抽取（强化版） ======= */
    function extractAll(raw){
      const text = sanitize(raw);
      const out = [];
      const seen = new Set();
      const push = (key,val,type)=>{ const v=(val||'').trim(); const k=key+'|'+v; if(v && !seen.has(k)){ seen.add(k); out.push({key,val:v,type}); } };

      // 1) 【标签】
      (text.match(/【([^】]+)】/g)||[]).forEach(t=> push('标签', t.replace(/【|】/g,''), 'tag'));

      // 2) URL
      (text.match(/https?:\/\/[^\s"'<>()，。；、）)]+/g)||[]).forEach(u=> push('链接', u, 'url'));

      // 3) 电话（手机/座机，允许空格/短横）
      (text.match(/(?<!\d)(1[3-9]\d[\s-]?\d{4}[\s-]?\d{4})(?!\d)/g)||[])
        .forEach(p=> push('电话', p.replace(/[\s-]/g,''), 'phone'));
      (text.match(/(?<!\d)(0\d{2,3}-?\d{7,8})(?!\d)/g)||[])
        .forEach(p=> push('座机', p, 'phone'));

      // 4) 时间（HH:MM）
      (text.match(/(?<!\d)([01]?\d|2[0-3]):[0-5]\d(?!\d)/g)||[]).forEach(t=> push('时间', t, 'time'));

      // 5) 取件码/验证码：含关键词 或 “凭X-1234/123456/AB1234”
      const codeKw = /(取件码|取货码|提取码|验证码|校验码|核验码|凭)\s*[:：]?\s*([A-Z]{1,3}?[- ]?\d{3,8}|\d{4,8})/gi;
      let m; while((m = codeKw.exec(text))) push('取件码', m[2].replace(/\s/g,''), 'code');
      // 关键词缺失时，靠“凭”+码 或者 JD/SF/中通等常见前缀
      const codeLoose = /(?:凭|码)\s*([A-Z]{1,3}?-?\d{3,8})/gi; let mm; while((mm = codeLoose.exec(text))) push('取件码', mm[1].replace(/\s/g,''), 'code');
      // 常见快递前缀 + 数字
      (text.match(/\b(?:JD|SF|ZTO|YT|YTO|STO|YD|BS|ZJS|HT|DB|S)?[A-Z]?[- ]?\d{4,8}\b/g)||[])
        .forEach(c=>{ if(/\d/.test(c)) push('可能的取件码', c.replace(/\s/g,''), 'code-maybe') });

      // 6) 尾号
      let t; const tail=/尾号\s*(\d{2,4})/g; while((t=tail.exec(text))) push('尾号', t[1], 'tail');

      // 7) 地址（从“地址/已送达至/到…/至 …”到下一锚点）
      const anchors = /(地址|取件地址|已送达|送达|到|至)\s*[:：]?\s*([\u4e00-\u9fa5A-Za-z0-9\-（）() ]{6,}?)(?=联系电话|电话|取件|寄件|请|https?:\/\/|。|，|；|$)/g;
      let a; while((a=anchors.exec(text))){ push('地址/地点', a[2].replace(/[，。；]$/,'').trim(), 'address'); }

      // 8) 地点（含 柜/楼/座/服务站/驿站 等，带格位）
      (text.match(/[\u4e00-\u9fa5A-Za-z0-9\- ]{0,20}(?:快递柜|近邻宝|服务站|驿站|新主楼|新北|[东南西北]侧)?[\u4e00-\u9fa5]*?(?:柜|楼|座)[\u4e00-\u9fa5 ]*([A-Z]-?\d{1,3}|\d+号柜|[A-Z]?\d{1,3})/g)||[])
        .forEach(l=> push('地点', l.trim(), 'location'));

      // 9) 纯数字串（>=6），排除电话/尾号
      const taken = new Set(out.filter(x=>x.type==='phone'||x.type==='tail').map(x=>x.val));
      (text.match(/\b\d{6,}\b/g)||[]).forEach(n=>{ if(!taken.has(n)) push('数字', n, 'number') });

      // 快递品牌（提示来源）
      (text.match(/京东快递|顺丰|中通|圆通|申通|韵达|邮政|EMS|极兔|德邦|菜鸟|驿小哥/gi)||[]) 
        .forEach(b=> push('快递', b, 'brand'));

      return out;
    }

    /* ======= 渲染 ======= */
    let extracted=[]; const selected=new Set();

    function renderParts(){
      const onlyCode = $('opt-onlycode').checked;
      const list = onlyCode ? extracted.filter(x=>x.type.startsWith('code')) : extracted;
      const box = $('parts'); box.innerHTML='';
      list.forEach((p,idx)=>{
        const i = document.createElement('div'); i.className = 'part' + (selected.has(idx)?' active':'');
        const k = document.createElement('div'); k.className='k'; k.textContent=p.key;
        const v = document.createElement('div'); v.className='v'; v.textContent=p.val;
        i.append(k,v);
        i.addEventListener('click', ()=> onPartClick(idx,p.val));
        box.appendChild(i);
      });
      updateCopySelected();
    }

    function onPartClick(idx,val){
      if(!$('opt-multi').checked){ copy(val, `已复制：${val}`, 'result'); return; }
      if(selected.has(idx)) selected.delete(idx); else selected.add(idx); renderParts();
    }

    function updateCopySelected(){
      const n = selected.size; const btn=$('btn-copy-selected');
      btn.textContent = `复制选中（${n}）`; btn.disabled = n===0;
    }

    /* ======= 从参数渲染结果页 ======= */
    function renderFromParams(){
      const sp = new URLSearchParams(location.search);
      const view = sp.get('view');
      if(view==='result'){
        show('view-result');
        const code = sp.get('code'); const values = sp.get('values'); const text = sp.get('text'); const mode = sp.get('mode'); const split = sp.get('split');
        selected.clear();
        if(code){ $('full').textContent = code; extracted = extractAll(code); renderParts(); copy(code,'已自动复制','result'); return; }
        if(values){ const arr = values.split(',').map(s=>s.trim()).filter(Boolean); $('full').textContent = arr.join('\n'); extracted = arr.map((v,i)=>({key:`项目${i+1}`,val:v,type:'item'})); renderParts(); return; }
        if(text){ $('full').textContent = text; if(split){ const segs = text.split(split.replace(/\\n/g,'\n')).map(s=>s.trim()).filter(Boolean); extracted = segs.map((v,i)=>({key:`部分${i+1}`,val:v,type:'part'})); } else if(mode==='auto'){ extracted = extractAll(text); } else { extracted=[]; }
          renderParts(); return; }
        // 没有参数：回输入
        show('view-input');
      } else {
        show('view-input');
      }
    }

    /* ======= 事件绑定 ======= */
    $('btn-go').addEventListener('click', ()=>{
      const t = $('ipt-text').value.trim(); if(!t){ toast('请输入内容',false,'input'); return; }
      const auto = $('ipt-auto').checked; const sp = $('ipt-split').value.trim();
      const params = { text: t };
      if(sp) params.split = sp; else if(auto) params.mode = 'auto';
      navigateToResult(params);
    });

    $('btn-link').addEventListener('click', ()=>{
      const t = $('ipt-text').value.trim(); if(!t){ toast('请输入内容以生成链接',false,'input'); return; }
      const auto = $('ipt-auto').checked; const sp = $('ipt-split').value.trim();
      const url = new URL(location.href); url.search = '';
      const p = new URLSearchParams(); p.set('view','result'); p.set('text',t);
      if(sp) p.set('split',sp); else if(auto) p.set('mode','auto');
      const out = url.toString() + '?' + p.toString();
      copy(out,'已复制分享链接','input');
    });

    $('btn-back').addEventListener('click', ()=> history.back());
    $('btn-copy-all').addEventListener('click', ()=> copy($('full').textContent,'已复制原文','result'));
    $('btn-copy-selected').addEventListener('click', ()=>{
      const list=[...selected].sort((a,b)=>a-b).map(i=>extracted[i].val).join('\n');
      copy(list,`已复制 ${selected.size} 项`,'result');
    });
    $('opt-multi').addEventListener('change', ()=>{ selected.clear(); renderParts(); });
    $('opt-onlycode').addEventListener('change', renderParts);

    // 初始渲染
    renderFromParams();
  </script>
</body>
</html>
