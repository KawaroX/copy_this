<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>快速复制</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', sans-serif;
            background: #f7f7f5;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #37352f;
        }
        
        .container {
            background: white;
            border-radius: 8px;
            padding: 48px 40px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05), 0 10px 40px rgba(0, 0, 0, 0.08);
            max-width: 600px;
            width: 100%;
        }
        
        .header {
            margin-bottom: 32px;
        }
        
        .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        h1 {
            font-size: 24px;
            font-weight: 600;
            color: #37352f;
            margin-bottom: 8px;
        }
        
        .subtitle {
            color: #787774;
            font-size: 14px;
        }
        
        .content-section {
            margin: 24px 0;
        }
        
        .label {
            font-size: 12px;
            font-weight: 600;
            color: #787774;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .display-box {
            background: #f7f7f5;
            border: 1px solid #e3e2e0;
            border-radius: 4px;
            padding: 16px;
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            font-size: 18px;
            color: #37352f;
            word-break: break-all;
            line-height: 1.6;
        }
        
        .parts-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 12px;
        }
        
        .part-item {
            background: #f7f7f5;
            border: 1px solid #e3e2e0;
            border-radius: 4px;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .part-item:hover {
            background: #f0f0ee;
            border-color: #d3d1cb;
        }
        
        /* 新增：选中状态的样式 */
        .part-item.selected {
            background: #e3f2fd;
            border-color: #90caf9;
        }
        
        .part-text {
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            font-size: 15px;
            color: #37352f;
            flex: 1;
        }
        
        .part-label {
            font-size: 11px;
            color: #787774;
            margin-bottom: 4px;
            font-weight: 500;
        }
        
        .copy-indicator {
            color: #787774;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .part-item:hover .copy-indicator {
            opacity: 1;
        }
        
        .button-group {
            display: flex;
            gap: 8px;
            margin-top: 24px;
        }
        
        .btn {
            flex: 1;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        
        .btn-primary {
            background: #37352f;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2e2c28;
        }
        
        .btn-primary:active {
            transform: scale(0.98);
        }
        
        .btn-secondary {
            background: white;
            color: #37352f;
            border: 1px solid #e3e2e0;
        }
        
        .btn-secondary:hover {
            background: #f7f7f5;
        }
        
        .status {
            margin-top: 16px;
            padding: 12px 16px;
            border-radius: 4px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status.show {
            opacity: 1;
        }
        
        .status.success {
            background: #edf3ec;
            color: #0f7b6c;
        }
        
        .status.error {
            background: #fdebec;
            color: #e03e3e;
        }
        
        .info-text {
            color: #9b9a97;
            font-size: 13px;
            margin-top: 20px;
            line-height: 1.5;
        }
        
        .divider {
            height: 1px;
            background: #e3e2e0;
            margin: 24px 0;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        .checkbox-item label {
            font-size: 14px;
            cursor: pointer;
            user-select: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="icon">📋</div>
            <h1 id="title">快速复制</h1>
            <div class="subtitle" id="subtitle">点击内容即可复制到剪贴板</div>
        </div>

        <div class="content-section" id="mainContent">
            <div class="label">内容</div>
            <div class="display-box" id="fullContent">-</div>
        </div>

        <div class="content-section" id="partsSection" style="display: none;">
            <div class="label">选择要复制的部分</div>
            <div class="parts-container" id="partsContainer"></div>
            <div class="checkbox-item" style="margin-top: 16px;">
                <input type="checkbox" id="copyAllCheckbox">
                <label for="copyAllCheckbox">一次性复制所有选中项</label>
            </div>
        </div>

        <div class="button-group">
            <button class="btn btn-primary" id="copyMainBtn">
                <span id="btnText">复制</span>
            </button>
            <button class="btn btn-secondary" id="copyAllBtn" style="display: none;">
                复制全部
            </button>
        </div>

        <div class="status" id="status"></div>

        <div class="divider"></div>

        <div class="info-text">
            <strong>使用方法：</strong><br>
            • 自动复制：<code>?code=取件码</code> (加载后自动复制)<br>
            • 基础复制：<code>?text=内容</code> (显示完整内容)<br>
            • 智能拆分：<code>?text=内容&mode=auto</code><br>
            • 自定义分隔：<code>?text=内容&split=,</code><br>
            • 多个值：<code>?values=值1,值2,值3</code>
        </div>
    </div>

    <script>
        let currentMode = 'simple';
        let extractedParts = [];
        let selectedParts = new Set();

        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                code: params.get('code'),
                text: params.get('text'),
                mode: params.get('mode'),
                split: params.get('split'),
                values: params.get('values'),
                title: params.get('title')
            };
        }

        // 优化的 autoExtractParts，避免重叠
        function autoExtractParts(text) {
            const parts = [];
            let remainingText = text;

            // 1. 提取中文括号内容
            // (?<=\【) 是正向后行断言，匹配 【 后面的内容，(?!=\】) 是负向前行断言，匹配不以 】 结尾的内容
            // 这种写法更精确，只提取括号内的内容
            const brackets = text.match(/【([^】]+)】/g);
            if (brackets) {
                brackets.forEach((item, i) => {
                    const content = item.replace(/【|】/g, '');
                    parts.push({ label: `标签 ${i + 1}`, value: content, type: 'tag' });
                    remainingText = remainingText.replace(item, ' '); // 从剩余文本中移除
                });
            }

            // 2. 提取地点信息 (增加了对 - 的支持)
            const locationRegex = /([\u4e00-\u9fa5A-Za-z0-9]+[柜楼]\s*[A-Z0-9-]+)/g;
            const locations = text.match(locationRegex);
            if (locations) {
                locations.forEach((loc, i) => {
                    parts.push({ label: `位置 ${i + 1}`, value: loc.trim(), type: 'location' });
                    remainingText = remainingText.replace(loc, ' '); // 从剩余文本中移除
                });
            }
            
            // 3. 提取剩余文本中的数字（\b 是单词边界，防止匹配到一半）
            const numbers = remainingText.match(/\b\d{6,}\b/g);
            if (numbers) {
                numbers.forEach((num, i) => {
                    parts.push({ label: `数字 ${i + 1}`, value: num, type: 'number' });
                });
            }
            
            return parts;
        }

        // 优化：使用 createElement 和 addEventListener
        function renderParts(parts) {
            const container = document.getElementById('partsContainer');
            container.innerHTML = '';
            
            parts.forEach((part, index) => {
                const div = document.createElement('div');
                div.className = 'part-item';
                // 行为绑定
                div.addEventListener('click', () => togglePart(index, part.value));
                
                const contentDiv = document.createElement('div');
                contentDiv.style.flex = '1';

                const labelDiv = document.createElement('div');
                labelDiv.className = 'part-label';
                labelDiv.textContent = part.label; // 使用 textContent 安全

                const textDiv = document.createElement('div');
                textDiv.className = 'part-text';
                textDiv.textContent = part.value; // 使用 textContent 安全

                contentDiv.appendChild(labelDiv);
                contentDiv.appendChild(textDiv);

                const indicatorDiv = document.createElement('div');
                indicatorDiv.className = 'copy-indicator';
                indicatorDiv.textContent = '点击复制';

                div.appendChild(contentDiv);
                div.appendChild(indicatorDiv);
                
                container.appendChild(div);
            });
        }

        function togglePart(index, value) {
            const checkbox = document.getElementById('copyAllCheckbox');
            
            if (checkbox.checked) {
                if (selectedParts.has(index)) {
                    selectedParts.delete(index);
                } else {
                    selectedParts.add(index);
                }
                updatePartSelection();
            } else {
                copyToClipboard(value, `已复制：${value}`);
            }
        }

        // 优化：使用 classList.toggle
        function updatePartSelection() {
            const items = document.querySelectorAll('.part-item');
            items.forEach((item, index) => {
                // 第二个参数为 true 时添加类，为 false 时移除类
                item.classList.toggle('selected', selectedParts.has(index));
            });
        }

        function showStatus(message, isSuccess) {
            const status = document.getElementById('status');
            status.innerHTML = `<span>${isSuccess ? '✓' : '✕'}</span> ${message}`;
            status.className = 'status show ' + (isSuccess ? 'success' : 'error');
            
            setTimeout(() => {
                status.classList.remove('show');
            }, 3000);
        }

        async function copyToClipboard(text, successMsg) {
            try {
                // 优先使用现代异步 Clipboard API
                await navigator.clipboard.writeText(text);
                showStatus(successMsg || '复制成功！', true);
            } catch (err) {
                // 降级处理
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '0';
                document.body.appendChild(textArea);
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    showStatus(successMsg || '复制成功！', true);
                } catch (err2) {
                    showStatus('复制失败，请手动复制', false);
                }
                
                document.body.removeChild(textArea);
            }
        }

        function copyContent() {
            const checkbox = document.getElementById('copyAllCheckbox');
            
            if (currentMode === 'parts' && checkbox.checked && selectedParts.size > 0) {
                const selected = extractedParts
                    .filter((_, index) => selectedParts.has(index))
                    .map(p => p.value)
                    .join('\n');
                copyToClipboard(selected, `已复制 ${selectedParts.size} 项内容`);
            } else if (currentMode === 'simple') {
                const content = document.getElementById('fullContent').textContent;
                copyToClipboard(content, '已复制');
            } else if (currentMode === 'parts' && !checkbox.checked) {
                 showStatus('请点击要复制的内容，或勾选“一次性复制”', false);
            } else if (currentMode === 'parts' && checkbox.checked && selectedParts.size === 0) {
                showStatus('请点击选择要复制的内容', false);
            }
        }

        function copyAll() {
            const content = document.getElementById('fullContent').textContent;
            copyToClipboard(content, '已复制完整内容');
        }

        function init() {
            const params = getUrlParams();
            
            if (params.title) {
                document.getElementById('title').textContent = decodeURIComponent(params.title);
            }
            
            if (params.code) {
                currentMode = 'simple';
                document.getElementById('fullContent').textContent = params.code;
                document.getElementById('subtitle').textContent = '内容已自动复制到剪贴板';
                copyToClipboard(params.code, '已自动复制');
                return;
            }
            
            if (params.values) {
                currentMode = 'parts';
                const values = params.values.split(',').map(v => v.trim());
                document.getElementById('fullContent').textContent = values.join('\n');
                extractedParts = values.map((v, i) => ({ 
                    label: `项目 ${i + 1}`, 
                    value: v,
                    type: 'item'
                }));
                renderParts(extractedParts);
                document.getElementById('partsSection').style.display = 'block';
                document.getElementById('copyAllBtn').style.display = 'block';
                document.getElementById('btnText').textContent = '复制选中';
                return;
            }
            
            if (params.text) {
                const text = decodeURIComponent(params.text);
                document.getElementById('fullContent').textContent = text;
                
                let processed = false;
                
                if (params.mode === 'auto') {
                    currentMode = 'parts';
                    extractedParts = autoExtractParts(text);
                    
                    if (extractedParts.length > 0) {
                        renderParts(extractedParts);
                        document.getElementById('partsSection').style.display = 'block';
                        document.getElementById('copyAllBtn').style.display = 'block';
                        document.getElementById('btnText').textContent = '复制选中';
                        processed = true;
                    }
                }
                
                if (params.split && !processed) { // 避免 auto 和 split 同时生效
                    currentMode = 'parts';
                    const parts = text.split(params.split).map(v => v.trim()).filter(v => v);
                    extractedParts = parts.map((v, i) => ({ 
                        label: `部分 ${i + 1}`, 
                        value: v,
                        type: 'part'
                    }));
                    renderParts(extractedParts);
                    document.getElementById('partsSection').style.display = 'block';
                    document.getElementById('copyAllBtn').style.display = 'block';
                    document.getElementById('btnText').textContent = '复制选中';
                }
                
                return;
            }
            
            showStatus('URL中未找到内容参数', false);
        }

        // --- 统一的事件监听器 ---
        
        window.addEventListener('load', init);
        
        document.getElementById('copyAllCheckbox').addEventListener('change', (e) => {
            if (!e.target.checked) {
                selectedParts.clear();
                updatePartSelection();
            }
        });

        document.getElementById('copyMainBtn').addEventListener('click', copyContent);
        document.getElementById('copyAllBtn').addEventListener('click', copyAll);
        
    </script>
</body>
</html>
